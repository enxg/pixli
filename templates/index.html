<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Pixli</title>

    <link href="/css/style.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">

    <script src="/js/htmx.min.js"></script>
</head>
<body>
    <div class="h-screen w-full flex flex-col items-center justify-center text-gray-50 bg-zinc-950 inter">
        <div class="flex flex-col gap-4 items-center justify-center w-1/2 p-6 rounded-xl shadow-xl bg-zinc-900">
            <h1 class="text-6xl font-bold">Pixli</h1>
            {{ if .Auth }}
            <div class="grid grid-cols-3 items-center w-full px-1">
                <span>
                    Logged in as <strong class="font-semibold">@{{.User.Username}}</strong>
                </span>
                <a href="/sharex" download class="text-green-600 hover:underline hover:cursor-pointer text-center">Download ShareX Config</a>
                <a href="?logout=true" class="flex flex-row gap-2 items-center justify-end text-red-500 hover:text-red-600 duration-150 font-semibold">
                    <svg class="h-4 w-auto" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="currentColor" fill-rule="evenodd" d="M9.707 2.409C9 3.036 9 4.183 9 6.476v11.048c0 2.293 0 3.44.707 4.067s1.788.439 3.95.062l2.33-.406c2.394-.418 3.591-.627 4.302-1.505c.711-.879.711-2.149.711-4.69V8.948c0-2.54 0-3.81-.71-4.689c-.712-.878-1.91-1.087-4.304-1.504l-2.328-.407c-2.162-.377-3.243-.565-3.95.062M12 10.169c.414 0 .75.351.75.784v2.094c0 .433-.336.784-.75.784s-.75-.351-.75-.784v-2.094c0-.433.336-.784.75-.784" clip-rule="evenodd"/><path fill="currentColor" d="M7.547 4.5c-2.058.003-3.131.048-3.815.732C3 5.964 3 7.142 3 9.5v5c0 2.357 0 3.535.732 4.268c.684.683 1.757.729 3.815.732c-.047-.624-.047-1.344-.047-2.123V6.623c0-.78 0-1.5.047-2.123"/></svg>
                    Logout
                </a>
            </div>
            <form class="flex flex-col gap-2 items-start w-full" hx-post="/api/shorten" hx-target="#list" hx-disabled-elt="#submit" hx-on::after-request="if(event.detail.successful) url.value=''">
                <div class="flex flex-row gap-2 items-center w-full">
                    <label class="flex flex-col gap-1 w-full">
                        <input type="text" id="url" name="url" class="w-full px-6 py-2 bg-zinc-800 shadow-xl rounded-lg" placeholder="https://hackclub.com" required />
                    </label>
                    <button id="submit" type="submit" class="px-6 py-2 bg-green-800 hover:bg-green-900 hover:cursor-pointer disabled:bg-green-900 disabled:cursor-not-allowed duration-150 shadow-xl rounded-lg">Shorten</button>
                </div>
                <details class="flex flex-col gap-2 w-full" id="advancedOptions">
                    <summary class="px-1 hover:cursor-pointer">Advanced Options</summary>
                    <div class="flex flex-row gap-2 w-full">
                        <label for="until" class="flex flex-col gap-1">
                            <label for="enableUntil" class="flex flex-row items-center gap-2 px-1">
                                <input type="checkbox" id="enableUntil" name="enableUntil" class="accent-green-600 w-4 h-4 duration-150 cursor-pointer disabled:cursor-not-allowed" />
                                <span>Valid Until</span>
                            </label>
                            <input type="datetime-local" id="until" name="until" class="px-6 py-2 bg-zinc-800 shadow-xl rounded-lg tabular-nums disabled:text-gray-50/54" disabled />
                            <input type="hidden" id="timezone" name="timezone" />
                        </label>
                    </div>
                </details>
                <ul class="list-disc list-inside my-2 px-1">
                    {{ range .Notices }}
                    <li>{{.}}</li>
                    {{ end }}
                </ul>
            </form>
            <div class="flex flex-col gap-1 w-full px-1" id="list">
                {{ template "url-list" . }}
            </div>
            {{ else }}
            <div class="flex flex-row w-max items-center justify-center">
                <a
                        href="https://github.com/login/oauth/authorize?client_id={{.GithubClientID}}"
                        class="flex flex-row items-center justify-center gap-2 px-6 py-2 bg-green-800 hover:bg-green-900 duration-150 shadow-xl rounded-lg">
                    <img src="/img/github.svg" class="h-5 w-auto"  alt="GitHub Logo"/>
                    Login with GitHub
                </a>
            </div>
            {{ end }}
        </div>
    </div>

    <script>
        function toDatetimeLocalValue(date) {
            const pad = n => n.toString().padStart(2, '0');
            return date.getFullYear() + '-' +
                pad(date.getMonth() + 1) + '-' +
                pad(date.getDate()) + 'T' +
                pad(date.getHours()) + ':' +
                pad(date.getMinutes());
        }

        history.pushState(null, "", location.href.split("?")[0]);

        const enableUntilCheckbox = document.getElementById("enableUntil");
        const untilInput = document.getElementById("until");
        const advancedOptions = document.getElementById("advancedOptions");
        const timezoneInput = document.getElementById("timezone");

        const userID = "{{.User.ID}}";
        const username = "{{.User.Username}}";
        const admin = "{{.User.Admin}}" === "true";

        const untilMaxEnabled = "{{.UntilMaxEnabled}}" === "true";

        if (!userID) {
            throw new Error("Not continuing as the user is not logged in")
        }

        timezoneInput.value = new Date().getTimezoneOffset();

        const untilMinTime = new Date("{{.UntilMin}}");
        untilInput.min = toDatetimeLocalValue(untilMinTime);

        if (untilMaxEnabled && !admin) {
            const untilMaxTime = new Date("{{.UntilMax}}");
            untilInput.max = toDatetimeLocalValue(untilMaxTime);

            enableUntilCheckbox.checked = true;
            enableUntilCheckbox.setAttribute("disabled", "true")

            untilInput.removeAttribute("disabled");
            untilInput.setAttribute("required", "true");
            untilInput.value = toDatetimeLocalValue(untilMaxTime);

            advancedOptions.open = true
        }

        enableUntilCheckbox.addEventListener("change", () => {
            if (enableUntilCheckbox.checked) {
                untilInput.removeAttribute("disabled");
                untilInput.setAttribute("required", "true");
            } else {
                untilInput.setAttribute("disabled", "true");
                untilInput.removeAttribute("required");
            }
        });
    </script>
</body>
</html>